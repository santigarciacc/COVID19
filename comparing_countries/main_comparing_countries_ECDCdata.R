# Remove all the variables
rm(list = ls())
assign("last.warning", NULL, envir = baseenv()) # Clean warnings

# DO NOT CHANGE: libraries required: Rcode that we will need
repos <- "http://cran.us.r-project.org"
if(!require(httr)) install.packages("httr", repos = repos)
if(!require(plotly)) install.packages("plotly", repos = repos)
if(!require(RColorBrewer)) install.packages("RColorBrewer", repos = repos)
if(!require(readxl)) install.packages("readxl", repos = repos)
if(!require(utils)) install.packages("utils", repos = repos)
if(!require(ggplot2)) install.packages("ggplot2", repos = repos)
if(!require(rgdal)) install.packages("rgdal", repos = repos,
                                     configure.args =
                                       c("--with-proj-lib=/usr/local/lib/",
                                         "--with-proj-include=/usr/local/include/"))
if(!require(sf)) install.packages("sf", repos = repos,
                                  configure.args =
                                    "--with-proj-lib=/usr/local/lib/")
if(!require(rnaturalearth)) install.packages("rnaturalearth", repos = repos)
if(!require(rnaturalearthdata)) install.packages("rnaturalearthdata",
                                                 repos = repos)
if(!require(geometry)) install.packages("geometry", repos = repos)
if(!require(maps)) install.packages("maps", repos = repos)
if(!require(rgeos)) install.packages("rgeos", repos = repos)
if(!require(tidyverse)) install.packages("tidyverse", repos = repos)
if(!require(stringr)) install.packages("stringr", repos = repos)


# DO NOT CHANGE: Source files, my own codes that we will need
setwd(dirname(rstudioapi::getSourceEditorContext()$path))
source('./aux_functions.R')
source('./countries_by_continents.R')


########################################
########################################
########################################


##
## PARAMETERS TO BE CHANGED: please, answer the following questions
##

# COUNTRIES: Which countries do you want to be compared??
# Codes country available (among others): AFG ARG ARM AUS AUT BEL BOL BRA CAN
# CHL CHN COL CUB CZE DNK ECU EGY SLV EST SWZ ETH FIN FRA DEU GRC ISL IND IRN
# IRL ITA JPN LUX MEX NLD NOR PER POL PRT RUS SEN KOR ESP SWE TUR GBR USA VEN

countries <- c("ESP", "ITA", "BOL", "ARG", "DEU", "GBR",
               "PRT", "JPN", "MEX", "USA", "MNG") 

# LOG: Do you want data in the original scale or in the log scale?
log <- FALSE # If log <- TRUE, cases and deaths are plotted in log scale

# DATES: Since when do you want to analysed?
from_date <- "2019-12-31" # Please, modify with a date in format "YYYY-mm-dd"
to_date <- format(Sys.time(), "%Y-%m-%d") # DO NOT CHANGE
dates <- as.Date(c(from_date, to_date)) # DO NOT CHANGE

# SAVE_LOCAL: Do you want to save in your computer the datasets? TRUE/FALSE
save_local <- TRUE

# N_HAB: Do you want to show all data in a relative way, in terms of
# each n_hab people? For example, each 10.000 people (n_hab = 10000)
n_hab <- 1e6 # If n_hab <- FALSE, deaths or cases are plotted as usual

# ALIGNED: Do you want to align the data, starting all graphics at Day 0,
# defining as the first day in which cumulative cases are greater than
# population * perc_pop (%)?
aligned_cases <- TRUE
perc_pop <- 0.0000025 # 0.00025 % of population
  
# PLOT_CASES, PLOT_DEATHS, PLOT_CUM_CASES, PLOT_CUM_DEATHS, PLOT_MORT_RATE
plot_cases <- TRUE # A graphic about the daily cases? TRUE/FALSE
plot_deaths <- TRUE # A graphic about the daily deaths? TRUE/FALSE
plot_cum_cases <- TRUE # A graphic about the cum. cases? TRUE/FALSE
plot_cum_deaths <- TRUE # A graphic about the cum. deaths? TRUE/FALSE
plot_mort_rate <- TRUE # A graphic about the mortality rate (cum deaths / cum cases)? TRUE/FALSE

# PLOT_V_CASES, PLOT_V_DEATHS, PLOT_A_CASES, PLOT_A_DEATHS
plot_v_cases <- TRUE # A graphic about the % growth (velocity) of cases? TRUE/FALSE
plot_v_deaths <- TRUE # A graphic about the % growth (velocity) of deaths? TRUE/FALSE
plot_a_cases <- TRUE # A graphic about the % growth of velocity of cases (acceleration)? TRUE/FALSE
plot_a_deaths <- TRUE # A graphic about the % growth of velocity of deaths (acceleration)? TRUE/FALSE
plot_dev_by_continents <- TRUE # A graphic about the data related to their continents
comm_mobility <- TRUE # Graphics related with Community Mobility Reports (source: Google)



##########################################
#### FROM HERE, DO NOT CHANGE THE CODE ###
##########################################

#
# Example of using: write
# ECDC_ESP$covid_data # covid19 data of Spain from the selected dates
# ECDC_ESP$country # Country code
# ECDC_ESP$population # Population in the databases are from the World Bank
#
# writting graphics_countries$fig_cum_deaths plots cumulative deaths
#
# If you write "graphics_countries$" (without quotes), and then, press tab key,
# a menu will appear with the different graphics available.


##
## DO NOT CHANGE: extracting from the ECDC (European Centre for Disease
##                Prevention and Control) or the  website
## 
## A complete data set ECDC_data is created
##  * ECDC_data$raw_data: the raw data directly downloaded
##  * ECDC_data$all_countries: all countries available
##  * ECDC_data$filter_countries: just the countries selected
##  * ECDC_data$filter_data[[i]]: just data from i-th country and dates selected
##
ECDC_data <-
  extracting_ECDC_covid19(dates = dates, countries = countries,
                          save_local = save_local)

# Each country is also stored in a list named as "ECDC_" + country code
for (i in 1:length(ECDC_data$filter_data)) {
  
  assign(paste0("ECDC_", ECDC_data$filter_countries[i]),
         ECDC_data$filter_data[[i]])
}

for (i in 1:length(ECDC_data$data_by_continents)) {
  
  assign(paste0("ECDC_", ECDC_data$data_by_continents[[i]]$continent),
         ECDC_data$data_by_continents[[i]])
}



#
# Example of using: write
# ECDC_ESP$covid_data # covid19 data of Spain from the selected dates
# ECDC_ESP$country # Country code
# ECDC_ESP$population # Population in the databases are from the World Bank
# ECDC_europe # Data of Europe


##
## DO NOT CHANGE: creating graphics
## Example: writting graphics_countries$fig_cum_deaths plots cumulative deaths
##
graphics_countries <-
  comparative_countries(ECDC_data, log = log, n_hab,
                        aligned_cases = aligned_cases,
                        perc_pop = perc_pop,
                        plot_cases = plot_cases, plot_deaths = plot_deaths,
                        plot_cum_cases = plot_cum_cases,
                        plot_cum_deaths = plot_cum_deaths,
                        plot_mort_rate = plot_mort_rate,
                        plot_v_cases = plot_v_cases,
                        plot_v_deaths = plot_v_deaths,
                        plot_a_cases = plot_a_cases,
                        plot_a_deaths = plot_a_deaths,
                        plot_dev_by_continents = plot_dev_by_continents,
                        comm_mobility = comm_mobility)


